#!/usr/bin/env sh

set -e

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  Pre-Commit Quality Gates"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# ── Gate 1: Protocol Zero (AI Attribution Scan) ──────────────────────
echo "[1/4] Protocol Zero enforcement..."
./tools/protocol-zero.sh --dir . || {
  echo ""
  echo "BLOCKED: Protocol Zero violation detected. Remove attribution markers."
  exit 1
}

# ── Gate 2: Secret Scanning ──────────────────────────────────────────
if command -v gitleaks >/dev/null 2>&1; then
  echo "[2/4] Secret scanning (gitleaks)..."
  gitleaks protect --staged --no-banner || {
    echo ""
    echo "BLOCKED: Secrets detected in staged files. Remove before committing."
    exit 1
  }
else
  echo "[2/4] Secret scanning... SKIPPED (gitleaks not installed)"
  echo "       Install: brew install gitleaks"
fi

# ── Gate 3: TypeScript Type Checking ─────────────────────────────────
echo "[3/4] Type checking (tsc --noEmit)..."
pnpm --silent run typecheck || {
  echo ""
  echo "BLOCKED: TypeScript type errors found. Fix before committing."
  exit 1
}

# ── Gate 4: Lint & Format Staged Files ───────────────────────────────
echo "[4/4] Linting and formatting staged files..."
npx lint-staged || {
  echo ""
  echo "BLOCKED: Biome lint/format errors. Run 'pnpm lint:fix' to auto-fix."
  exit 1
}

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  All gates passed"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
